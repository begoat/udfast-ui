$css4: true;
$compatibility: true;
//it is nessesary to define the variables in sass map instead of :root, for compatibility reasons.

$variables: (
  --color: white,
  --background: skyblue,
  --font: sans-serif,
);

// Here we transfer the variables from the map to the :root element
@if($css4) {
  :root {
    @each $variable, $value in $variables {
      #{$variable}: $value;
    }
  }

  // TODO: won't work in IE.
  // TODO: need use js to control it.
  @media (prefers-color-scheme: dark) {
    :root {
      // @each $variable, $value in $variables {
      //   #{$variable}: nth($value, 2);
      // }

      --color: black;
      --background: yellow;
      --font: sans-serif;
    }
  }
}

//this is the "magic" function
@function var($variable) {
  @if($css4) {
    @return unquote('var(' + $variable + ')');
  } @else {
    @return map-get($variables, $variable);
  }
}

/**
 * TODO: maybe we can tune this mixin to support multi themes fallback
 * pass a param to @content block, get value from a variable list
 */
// the mixin temporally sets the $css4 variable to false, compiles the css3 fallback, then makes the variable true again and compiles the css4 code. It should contain properties that use css4 variables, otherwise there will be unnessesary duplication of properties.
@mixin css4 {
  @if ($css4) {
    $css4-backup: $css4;
    @if($compatibility) {
      $css4: false !global;
      @content;
    }
    $css4: true !global;
    @content;
    $css4: $css4-backup;
  }
  @else {
    @content;
  }
}
